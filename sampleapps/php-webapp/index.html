<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>simple-bank-balance</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4" crossorigin="anonymous"></script>

    <script>

    function loading() {
      $("#info").addClass('loading-hide');
      $("#balanceTable").addClass('loading-hide');
      $("#loadingIndicator").removeClass('loading-hide');
      $("#loadingIndicator").addClass('loading-show');
      $("#refresh > span").removeClass('loading-hide');
      $("#refresh > span").addClass('loading-show');
      $("#refresh").html("Loading...");
    }

    function getRequestDone(response) {
      $("#balanceTable").html("");
      $("#info").removeClass('loading-hide');
      $("#balanceTable").removeClass('loading-hide');
      $("#loadingIndicator").addClass('loading-hide');
      $("#loadingIndicator").removeClass('loading-show');
      $("#refresh > span").addClass('loading-hide');
      $("#refresh > span").removeClass('loading-show');
      $("#refresh").html("Refresh");

      $("#balance-form")[0].reset();
      var len = response.data.length;
      for(var i=0; i<len; i++){
        var balance = response.data[i].balance;
        var id = response.data[i].id;
        var database = response.data[i].frontend;
        var frontend = response.data[i].frontend;
        var backend = response.data[i].backend;

        $("#balanceTable").append(`<li class="list-group-item d-flex justify-content-between lh-sm">
          <div>
            <h6 class="my-0">Database ID</h6>
            <small class="text-muted">${id}</small>
          </div>
          <span class="text-muted">${balance}</span>
        </li>`);

        $("#read-path").html("<br>Database Server:  " + database + "<br>Backend Server:" + backend + "<br>Frontend Server:" + frontend);
      }
    }

    $(document).ready(function(){
        loading()

        var getRequest;

        getRequest = $.ajax({
            url: 'v1/controller/balance.php',
            type: 'GET',
            dataType: 'JSON'
        });

        getRequest.done(function (response, textStatus, jqXHR){
          getRequestDone(response)
        });

        $("#balance-form").submit(function(event){
          var postRequest;
          event.preventDefault();

          var $form = $(this);
          var serializedData = $form.serialize();
          console.log(serializedData);

          var $inputs = $form.find("input, button");  
          $inputs.prop("disabled", true);

          postRequest = $.ajax({
              url: "/v1/controller/balance.php",
              type: "POST",
              data: serializedData
          });

          postRequest.done(function (response, textStatus, jqXHR){
            loading()
            var getRequest;
            getRequest = $.ajax({
                url: 'v1/controller/balance.php',
                type: 'GET',
                dataType: 'JSON'
            });

            getRequest.done(function (response, textStatus, jqXHR){
              getRequestDone(response)
            });

            getRequest.fail(function (jqXHR, textStatus, errorThrown){
                console.error(
                    "The following error occurred: "+
                    textStatus, errorThrown
                );
            });
          });

          postRequest.fail(function (jqXHR, textStatus, errorThrown){
            console.error(
                "The following error occurred: "+
                textStatus, errorThrown
            );
          });

          postRequest.always(function () {
            $inputs.prop("disabled", false);
          });
        });

        $("#result-form").submit(function(event){
          var postRequest;
          event.preventDefault();
          loading()

          var getRequest;
          getRequest = $.ajax({
              url: 'v1/controller/balance.php',
              type: 'GET',
              dataType: 'JSON'
          });

          getRequest.done(function (response, textStatus, jqXHR){
            getRequestDone(response)
          });

          getRequest.fail(function (jqXHR, textStatus, errorThrown){
              console.error(
                  "The following error occurred: "+
                  textStatus, errorThrown
              );
          });
        });

    });
    </script>

    <link href="form-validation.css" rel="stylesheet">

</head>

<body class="bg-light">

    <div class="container">
      <main>
        <div class="py-5 text-center">
          <h2>Balance form</h2>
          <p class="lead">
            Simple app to show which services or 
            virtual server instance respond to a submission.
          </p>
        </div>

        <div class="row g-5">
          <div class="col-md-7 col-lg-8 order-md-last">
            <form class="card p-2" id="result-form" action="" method="post">
              <button id="refresh" type="submit" class="btn btn-primary" type="button">
                <span class="spinner-border spinner-border-sm loading-hide" role="status" aria-hidden="true"></span>
                Refresh
              </button>
            </form>

            <ul id="info"  class="list-group mb-3">
              <li class="list-group-item d-flex justify-content-between bg-light">
                <div class="text-success">
                  <h6 class="my-0">Service(s) or Instance(s) that serviced this request:</h6>
                  <small><div id="read-path"></div></small>
                </div>
              </li>
            </ul>

            <ul id="balanceTable"  class="list-group mb-3">
            </ul>

          </div>

          <div class="col-md-5 col-lg-4">
            <h4 class="mb-3">Update balance</h4>
            <form class="needs-validation" id="balance-form" action="" method="post" novalidate>
              <div class="row g-3">
                <div class="col-12">
                  <label for="balance" class="form-label">Balance</label>
                  <input
                    type="text"
                    name="balance"
                    class="form-control"
                    id="balance"
                    placeholder=""
                    value=""
                    required
                    pattern="[0-9]"
                    type="number" min="1" max="4" value="0"
                  />
                  <div class="invalid-feedback">
                    Valid balance is required.
                  </div>
                </div>

              <button class="w-100 btn btn-primary btn-lg" type="submit" name="submit">
                Submit
              </button>
            </form>
          </div>
        </div>
      </main>

    </div>

  <script src="form-validation.js"></script>
</body>

</html>