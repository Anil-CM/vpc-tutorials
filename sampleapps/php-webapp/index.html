<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>simple-bank-balance</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4" crossorigin="anonymous"></script>

    <script>

    function loading() {
      $("#info").addClass('loading-hide');
      $("#balanceTable").addClass('loading-hide');
      $("#loadingIndicator").removeClass('loading-hide');
      $("#loadingIndicator").addClass('loading-show');
      $("#refresh > span").removeClass('loading-hide');
      $("#refresh > span").addClass('loading-show');
      $("#refresh").html("Loading...");
    }

    function getRequestDone(response) {
      $("#balanceTable").html("");
      $("#info").removeClass('loading-hide');
      $("#balanceTable").removeClass('loading-hide');
      $("#loadingIndicator").addClass('loading-hide');
      $("#loadingIndicator").removeClass('loading-show');
      $("#refresh > span").addClass('loading-hide');
      $("#refresh > span").removeClass('loading-show');
      $("#refresh").html("Refresh");

      $("#balance-form")[0].reset();
      var len = response.data.length;
      for(var i=0; i<len; i++){
        var balance = response.data[i].balance;
        var id = response.data[i].id;
        var database = response.data[i].database;
        var databaseShort = response.data[i].database.split(".")[0];
        var frontend = response.data[i].frontend;
        var frontendip = response.data[i].frontendip;
        var backend = response.data[i].backend;
        var backendip = response.data[i].backendip;

        $("#balanceTable").append(`<li class="list-group-item d-flex justify-content-between lh-sm">
          <div>
            <h6 class="my-0">Database ID</h6>
            <small class="text-muted">${id}</small>
          </div>
          <span class="text-muted">${balance}</span>
          <span>
            <h6 class="my-0">Balance</h6>
            <small class="text-muted">${balance}</small>
          </span>
        </li>`);

        $("#read-path").html(`
          <br><span data-bs-toggle="tooltip" data-bs-placement="top" title="IP Address: ${frontendip}">Frontend: ${frontend}</span>
          <br>
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-down-circle-fill" viewBox="0 0 16 16">
            <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8.5 4.5a.5.5 0 0 0-1 0v5.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V4.5z"/>
          </svg>
          <br>
            <span data-bs-toggle="tooltip" data-bs-placement="top" title="IP Address: ${backendip}">Backend: ${backend}</span>
          <br>
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-down-circle-fill" viewBox="0 0 16 16">
            <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8.5 4.5a.5.5 0 0 0-1 0v5.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V4.5z"/>
          </svg>
          <br>
            <img class="d-block mx-auto mb-4" src="https://broker.us-south.databases.cloud.ibm.com/images/postgresql.svg" alt="" width="30" height="30">
            <span data-bs-toggle="tooltip" data-bs-placement="top" title="Full Hostname: ${database}">Database: ${databaseShort}</span>
        `);

      }
    }

    $(document).ready(function(){
        loading()

        var getRequest;

        getRequest = $.ajax({
            url: 'v1/controller/balance.php',
            type: 'GET',
            dataType: 'JSON'
        });

        getRequest.done(function (response, textStatus, jqXHR){
          getRequestDone(response)
        });

        $("#balance-form").submit(function(event){
          var postRequest;
          event.preventDefault();

          var $form = $(this);
          var serializedData = $form.serialize();
          console.log(serializedData);

          var $inputs = $form.find("input, button");  
          $inputs.prop("disabled", true);

          postRequest = $.ajax({
              url: "/v1/controller/balance.php",
              type: "POST",
              data: serializedData
          });

          postRequest.done(function (response, textStatus, jqXHR){
            loading()
            var getRequest;
            getRequest = $.ajax({
                url: 'v1/controller/balance.php',
                type: 'GET',
                dataType: 'JSON'
            });

            getRequest.done(function (response, textStatus, jqXHR){
              getRequestDone(response)
            });

            getRequest.fail(function (jqXHR, textStatus, errorThrown){
                console.error(
                    "The following error occurred: "+
                    textStatus, errorThrown
                );
            });
          });

          postRequest.fail(function (jqXHR, textStatus, errorThrown){
            console.error(
                "The following error occurred: "+
                textStatus, errorThrown
            );
          });

          postRequest.always(function () {
            $inputs.prop("disabled", false);
          });
        });

        $("#result-form").submit(function(event){
          var postRequest;
          event.preventDefault();
          loading()

          var getRequest;
          getRequest = $.ajax({
              url: 'v1/controller/balance.php',
              type: 'GET',
              dataType: 'JSON'
          });

          getRequest.done(function (response, textStatus, jqXHR){
            getRequestDone(response)
          });

          getRequest.fail(function (jqXHR, textStatus, errorThrown){
              console.error(
                  "The following error occurred: "+
                  textStatus, errorThrown
              );
          });
        });

    });
    </script>

    <link href="form-validation.css" rel="stylesheet">

</head>

<body class="bg-light">

    <div class="container">
      <main>
        <div class="py-5 text-center">
          <h2>Balance form</h2>
          <p class="lead">
            Simple app to show which services or 
            virtual server instance respond to a submission.
          </p>
        </div>

        <div class="row g-3">
          <div class="col-12">
            <h4 class="mb-3">Update balance</h4>
            <form class="card p-2" id="balance-form" action="" method="post" novalidate>
              <div class="row g-3">
                <div class="col-12">
                  <label for="balance" class="form-label">Balance</label>
                  <input
                    type="text"
                    name="balance"
                    class="form-control"
                    id="balance"
                    placeholder=""
                    value=""
                    required
                    pattern="[0-9]"
                    type="number" min="1" max="4" value="0"
                  />
                  <div class="invalid-feedback">
                    Valid balance is required.
                  </div>
                </div>
              
              <button class="btn btn-primary" type="submit" name="submit">
                Submit
              </button>
            </div>
            </form>
          </div>
        </div>

        <div class="row g-3">
          <div class="col-md-7 col-lg-8">
            <form class="card p-2" id="result-form" action="" method="post">
              <button id="refresh" type="submit" class="btn btn-primary" type="button">
                <span class="spinner-border spinner-border-sm loading-hide" role="status" aria-hidden="true"></span>
                Refresh
              </button>
            </form>

            <ul id="balanceTable"  class="list-group mb-3">
            </ul>

          </div>

          <div class="col-md-5 col-lg-4">
            <div id="info" class="text-success">
              <h6 class="my-0">Service(s) or Instance(s) that serviced this request:</h6>
              <small><div id="read-path"></div></small>
            </div>
          </div>

        </div>
      </main>

    </div>

  <script src="form-validation.js"></script>
  <script>
    (function () {
      'use strict'
      var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
      tooltipTriggerList.forEach(function (tooltipTriggerEl) {
        new bootstrap.Tooltip(tooltipTriggerEl)
      })
    })()
  </script>
</body>

</html>